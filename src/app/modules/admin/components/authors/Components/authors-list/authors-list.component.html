<div class="surface-ground px-4 py-5 md:px-6 lg:px-8">
    <p-toast></p-toast>

    <!-- Header Section -->
    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
        <div>
            <h1 class="text-3xl font-bold text-900 mb-1">Authors</h1>
            <span class="text-600">Manage your library authors</span>
        </div>
        <div class="mt-3 md:mt-0">
            <button pButton pRipple label="Add Author" icon="pi pi-plus" class="p-button-primary"
                (click)="addAuthor()"></button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="surface-card p-4 mb-4 border-round shadow-2">
        <div class="flex flex-column md:flex-row gap-3">
            <div class="flex-grow-1">
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input type="search" pInputText class="w-full" [value]="AuthorParams.search"
                        placeholder="Search authors..." (input)="onFilter($event)">
                </span>
            </div>
            <!-- <p-dropdown [options]="sortOptions" placeholder="Sort By" styleClass="w-full md:w-15rem"
                (onChange)="onSortChange($event)"></p-dropdown> -->
        </div>
    </div>

    <!-- Loading State -->
    <app-loading-state *ngIf="loading" message="Loading authors..."></app-loading-state>

    <!-- Authors Grid -->
    <p-dataView *ngIf="!loading" #dv [value]="authors" [paginator]="true" [rows]="12" [totalRecords]="TotalCount"
        [lazy]="true" (onPage)="onPageChange($event)" [loading]="loading" [first]="currentPage * 12"
        class="authors-grid">
        <ng-template pTemplate="list">
            <div class="grid">
                <div class="col-12 md:col-6 lg:col-4 xl:col-3" *ngFor="let author of authors">
                    <div
                        class="surface-card h-full border-round-xl shadow-2 p-0 relative hover:shadow-4 transition-duration-200">
                        <!-- Status Badge -->
                        <div class="absolute top-0 right-0 m-2">
                            <p-tag [severity]="author.isActive ? 'success' : 'danger'"
                                [value]="author.isActive ? 'Active' : 'Inactive'">
                            </p-tag>
                        </div>

                        <!-- Author Image -->
                        <div class="relative">
                            <img [src]="author.imageURL ?? 'assets/media/dummy-photo-list.jpg'" [alt]="author.fullName"
                                class="w-full border-round-top-xl" style="height: 200px; object-fit: fit;">
                            <div class="absolute bottom-0 left-0 right-0 p-3 bg-black-alpha-50">
                                <h3 class="text-white m-0 font-semibold text-xl">{{author.fullName}}</h3>
                            </div>
                        </div>

                        <!-- Author Info -->
                        <div class="p-3">
                            <p class="text-600 line-height-3 mb-3" [pTooltip]="author.description" tooltipPosition="top"
                                [showDelay]="1000"
                                style="height: 4.5rem; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
                                {{author.description}}
                            </p>

                            <div class="flex flex-column gap-2">
                                <div class="flex align-items-center text-600">
                                    <i class="pi pi-calendar mr-2"></i>
                                    <span>{{author.dateOfBirth | date:'mediumDate'}}</span>
                                </div>
                                <div class="flex align-items-center text-600">
                                    <i class="pi pi-book mr-2"></i>
                                    <span>{{author.bookCount}} {{author.bookCount === 1 ? 'Book' : 'Books'}}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="border-top-1 surface-border p-3">
                            <div class="flex justify-content-between">
                                <button pButton pRipple type="button"
                                    [label]="author.isActive ? 'Deactivate' : 'Activate'"
                                    [class]="author.isActive ? 'p-button-danger p-button-outlined' : 'p-button-success p-button-outlined'"
                                    (click)="DeactivateOrActivate(author)">
                                </button>
                                <div class="flex gap-2">
                                    <button pButton pRipple type="button" icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text" (click)="editAuthor(author)">
                                    </button>
                                    <button pButton pRipple type="button" icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger"
                                        (click)="deleteAuthor(author)">
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ng-template>
        <ng-template pTemplate="empty">
            <div class="surface-card p-6 shadow-2 border-round text-center">
                <i class="pi pi-search text-600 text-6xl mb-4"></i>
                <h2 class="text-900 font-bold text-2xl mb-2">No Authors Found</h2>
                <p class="text-600 mb-4">We couldn't find any authors matching your criteria.</p>
                <button pButton pRipple label="Add New Author" icon="pi pi-plus" class="p-button-primary"
                    (click)="addAuthor()"></button>
            </div>
        </ng-template>
    </p-dataView>
</div>

<!-- Add/Edit Author Dialog -->
<p-dialog [(visible)]="authorDialog" [style]="{ width: '90vw', maxWidth: '1200px' }" [header]="headerDialog"
    [modal]="true" (onHide)="declineAddAuthorDialog()" class="author-dialog" [maximizable]="true"
    [contentStyle]="{'padding': '0'}">
    <ng-template pTemplate="content">
        <form [formGroup]="authorForm" class="surface-section">
            <div class="grid grid-nogutter">
                <!-- Left Column - Image Upload -->
                <div class="col-12 md:col-5 p-4 surface-ground">
                    <div class="surface-card p-4 border-round shadow-2">
                        <h2 class="text-xl font-semibold text-900 mb-4">Author Image</h2>
                        <div class="flex flex-column align-items-center">
                            <div class="image-upload-container cursor-pointer w-full relative"
                                (click)="triggerImageUpload()">
                                <img [src]="imageUrl" alt="Author Image" class="border-round-xl w-full shadow-2"
                                    style="height: 400px; object-fit: cover;" />
                                <div
                                    class="upload-overlay flex flex-column gap-2 align-items-center justify-content-center">
                                    <i class="pi pi-upload text-4xl"></i>
                                    <span class="text-sm">Click to upload image</span>
                                </div>
                            </div>
                            <div class="mt-3 text-center">
                                <p class="text-600 mb-2">Recommended: 800px X 500px</p>
                                <!-- <p class="text-600 text-sm">Supported formats: JPG, PNG, WebP</p> -->
                            </div>
                        </div>
                        <input type="file" id="myBookImage" class="hidden" accept="image/*"
                            (change)="handleImageSelection($event)" />
                    </div>
                </div>

                <!-- Right Column - Author Details -->
                <div class="col-12 md:col-7 p-4">
                    <div class="surface-card p-4 border-round shadow-2">
                        <h2 class="text-xl font-semibold text-900 mb-4">Author Details</h2>

                        <div class="field mb-4">
                            <label for="fullName" class="text-900 font-medium mb-2 block">Full Name</label>
                            <span class="p-input-icon-left w-full">
                                <i class="pi pi-user"></i>
                                <input type="text" pInputText id="fullName" formControlName="fullName"
                                    placeholder="Enter author's full name" class="w-full p-inputtext-lg"
                                    [ngClass]="{'ng-invalid ng-dirty': (submitted && fullName.invalid) || fullName.hasError('maxlength')}" />
                            </span>
                            <small *ngIf="submitted && fullName.hasError('required')" class="p-error block mt-2">Full
                                Name is required</small>
                            <small *ngIf="fullName.hasError('maxlength')" class="p-error block mt-2">Maximum length is
                                50 characters</small>
                        </div>

                        <div class="field mb-4">
                            <label for="description" class="text-900 font-medium mb-2 block">Biography</label>
                            <textarea pInputTextarea id="description" formControlName="description"
                                placeholder="Write a detailed biography about the author" rows="6" class="w-full"
                                [autoResize]="true"
                                [ngClass]="{'ng-invalid ng-dirty': submitted && !authorForm.controls['description'].valid}">
                            </textarea>
                            <small class="p-error block mt-2"
                                *ngIf="submitted && description.hasError('required')">Biography is required</small>
                        </div>

                        <div class="field mb-4">
                            <label for="dateOfBirth" class="text-900 font-medium mb-2 block">Date of Birth</label>
                            <p-calendar formControlName="dateOfBirth" [showIcon]="true" inputId="dateOfBirth"
                                [maxDate]="maxDate" placeholder="Select date of birth" styleClass="w-full"
                                [showTime]="false" dateFormat="yy-mm-dd" [showButtonBar]="true"
                                [ngClass]="{'ng-invalid ng-dirty': submitted && !authorForm.controls['dateOfBirth'].valid}">
                            </p-calendar>
                            <small *ngIf="submitted && !authorForm.controls['dateOfBirth'].valid"
                                class="p-error block mt-2">Date of birth is required</small>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </ng-template>
    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text"
                (click)="declineAddAuthorDialog()"></button>
            <button pButton pRipple [label]="isEditing ? 'Update Author' : 'Create Author'" icon="pi pi-check"
                class="p-button-primary" (click)="saveAuthor()"></button>
        </div>
    </ng-template>
</p-dialog>

<!-- Delete Confirmation Dialog -->
<p-dialog [(visible)]="deletionAuthorDialog" header="Confirm Deletion" [modal]="true" [style]="{width: '450px'}">
    <div class="flex align-items-center gap-3 p-3">
        <i class="pi pi-exclamation-triangle text-yellow-600 text-5xl"></i>
        <div>
            <h3 class="m-0 mb-2">Delete Author</h3>
            <p class="m-0" *ngIf="author">Are you sure you want to delete <span class="font-bold">{{ author.fullName
                    }}</span>?</p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text"
            (click)="declineDeletion()"></button>
        <button pButton pRipple label="Delete" icon="pi pi-trash" class="p-button-danger"
            (click)="confirmDeletion(author.id)"></button>
    </ng-template>
</p-dialog>

<!-- Activation Status Dialog -->
<p-dialog [(visible)]="switchActivationAuthorDialog" header="Confirm Status Change" [modal]="true"
    [style]="{width: '450px'}">
    <div class="flex align-items-center gap-3 p-3">
        <i class="pi pi-exclamation-circle text-blue-600 text-5xl"></i>
        <div>
            <h3 class="m-0 mb-2">Change Author Status</h3>
            <p class="m-0" *ngIf="author">
                Are you sure you want to {{ author.isActive ? 'deactivate' : 'activate' }}
                <span class="font-bold">{{ author.fullName }}</span>?
            </p>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text"
            (click)="declineActivation()"></button>
        <button pButton pRipple label="Confirm" icon="pi pi-check"
            [class]="author?.isActive ? 'p-button-danger' : 'p-button-success'" (click)="confirmActivation(author.id)">
        </button>
    </ng-template>
</p-dialog>