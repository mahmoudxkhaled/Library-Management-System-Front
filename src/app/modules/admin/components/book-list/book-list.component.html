<div class="books-container">
    <div class="card">
        <div class="header-section">
            <div class="title-section">
                <h2>Books</h2>
                <p class="subtitle">Manage your library books</p>
            </div>
            <div class="grid">
            <div class="col"><p-multiSelect  [options]="excelColumns" [(ngModel)]="selectedFilters"   optionLabel="name" placeholder="Select columns" /></div>
            <div class="col"><button pButton pRipple label="Export to Excel" icon="pi pi-file-excel" class="p-button-success" (click)="ExportToExcel()"></button></div>
            <div class="col"><div class="search-bar">
         <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
                    <input pInputText type="text" (input)="onSearch()" [(ngModel)]="bookParams.Search" placeholder="Search books..." />
         </span>
      </div></div>
      <div class="col"><button pButton pRipple label="Add New Book" icon="pi pi-plus" class="p-button-primary" (click)="showAddBookDialog()"></button></div>
            </div>
        </div>

        <!-- Loading State -->
        <app-loading-state *ngIf="loading" message="Loading books..."></app-loading-state>

        <!-- Books Grid -->
        <p-dataView #dv [value]="filteredBooks" [paginator]="true" [rows]="9" layout="grid" *ngIf="!loading">
            <ng-template let-books pTemplate="gridItem">
                <div class="grid grid-nogutter">
                    <div class="my-3 px-3 col-12 md:col-4" *ngFor="let book of books">
                        <div class="book-card">
                            <div class="image-container" (click)="editBook(book)">
                                <img [src]="book.imageUrl ?? 'assets/media/dummy-book.jpg'" [alt]="book.title"
                                    class="book-image" />
                                <div class="image-overlay">
                                    <i class="pi pi-pencil"></i>
                                </div>
                            </div>
                            <div class="book-content">
                                <div class="book-header">
                                    <h3>{{ book.title }}</h3>
                                    <button pButton pRipple type="button" icon="pi pi-ellipsis-v"
                                        class="p-button-rounded p-button-text p-button-plain"
                                        (click)="menu.toggle($event); selectedBook = book">
                                    </button>
                                </div>
                                <p-menu #menu [model]="menuItems" [popup]="true" [appendTo]="'body'"></p-menu>
                                <p class="description">{{ book.description }}</p>
                                <div class="book-footer">
                                    <div class="book-info">
                                        <i class="pi pi-user"></i>
                                        <span>{{ book.author }}</span>
                                    </div>
                                    <div class="book-status" [ngClass]="{'available': book.availableCopies > 0}">
                                        {{ book.availableCopies > 0 ? 'Available' : 'Borrowed' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>
        </p-dataView>
    </div>
</div>

<!-- Add/Edit Book Dialog -->
<p-dialog [(visible)]="bookDialog" [style]="{ width: '50%', maxHeight: '90vh' }"
    [header]="isEditing ? 'Edit Book' : 'Add New Book'" [modal]="true" class="p-fluid">
    <ng-template pTemplate="content">
        <form [formGroup]="bookForm" (ngSubmit)="saveBook()">
            <div class="p-grid p-fluid">
                <div class="p-col-12 p-md-6">
                    <div class="field p-col-12">
                        <label for="title" class="font-medium text-900">Title</label>
                        <input type="text" pInputText id="title" formControlName="title" placeholder="Enter book title"
                            required
                            [ngClass]="{'ng-invalid ng-dirty': submitted && !bookForm.controls['title'].valid}" />
                        <small *ngIf="submitted && !bookForm.controls['title'].valid"
                            class="ng-dirty ng-invalid text-red-500">Title is required</small>
                    </div>

                    <div class="field p-col-12">
                        <label for="author" class="font-medium text-900">Author</label>
                        <input type="text" pInputText id="author" formControlName="author"
                            placeholder="Enter author name" required
                            [ngClass]="{'ng-invalid ng-dirty': submitted && !bookForm.controls['author'].valid}" />
                        <small *ngIf="submitted && !bookForm.controls['author'].valid"
                            class="ng-dirty ng-invalid text-red-500">Author is required</small>
                    </div>

                    <div class="field p-col-12">
                        <label for="description" class="font-medium text-900">Description</label>
                        <textarea pInputTextarea id="description" formControlName="description"
                            placeholder="Write a description for this book" required rows="5"
                            [ngClass]="{'ng-invalid ng-dirty': submitted && !bookForm.controls['description'].valid}">
                        </textarea>
                        <small *ngIf="submitted && !bookForm.controls['description'].valid"
                            class="ng-dirty ng-invalid text-red-500">Description is required</small>
                    </div>

                    <div class="field p-col-12">
                        <label for="copies" class="font-medium text-900">Number of Copies</label>
                        <p-inputNumber id="copies" formControlName="copies" [showButtons]="true" [min]="1"
                            buttonLayout="horizontal" spinnerMode="horizontal" decrementButtonClass="p-button-secondary"
                            incrementButtonClass="p-button-secondary" incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus">
                        </p-inputNumber>
                    </div>
                </div>

                <div class="p-col-12 p-md-6 p-mt-2">
                    <p-panel header="Book Cover Image" class="mb-3">
                        <div class="flex flex-column align-items-center justify-content-center w-full">
                            <div class="image-upload-container w-full" (click)="triggerImageUpload()">
                                <img [src]="imageUrl" alt="Book Cover" class="upload-preview-image"
                                    [ngClass]="{'has-image': imageUrl}" />
                                <div class="upload-hover-text">
                                    <i class="pi pi-upload"></i>
                                    <span>Click to upload image</span>
                                </div>
                            </div>
                            <small class="text-center block mt-2">Recommended Dimensions: <strong>800px x
                                    500px</strong></small>
                        </div>
                        <input type="file" id="bookCoverImage" style="display: none"
                            (change)="handleImageSelection($event)" accept="image/*" />
                    </p-panel>
                </div>
            </div>
        </form>
    </ng-template>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple [label]="isEditing ? 'Update' : 'Save'" icon="pi pi-check" class="p-button-primary"
            (click)="saveBook()"></button>
    </ng-template>
</p-dialog>

<!-- Delete Book Dialog -->
<p-dialog [(visible)]="deletionBookDialog" header="Delete Book" [modal]="true"
    [style]="{ width: 'auto', maxWidth: '90%' }">
    <div class="flex align-items-center justify-content-center">
        <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem; color: #dc3545;"></i>
        <span *ngIf="selectedBook">Are you sure you want to delete <b>{{ selectedBook.title }}</b>?</span>
    </div>
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancel" icon="pi pi-times" class="p-button-text"
            (click)="deleteBookDialog = false"></button>
        <button pButton pRipple label="Delete" icon="pi pi-trash" class="p-button-danger"
            (click)="deleteBook()"></button>
    </ng-template>
</p-dialog>
<p-toast></p-toast>
